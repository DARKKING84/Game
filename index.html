 // Developer:- ìÜ©·é†·•≤ ÄŒ∫ìÜ™Í™æ|| ‡§Ö‡§Ç‡§§‡§É ‡§Ö‡§∏‡•ç‡§§‡§ø ‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠ ||

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Space Warfare</title>
    <style>
        body { margin: 0; background-color: #000; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: white; overflow: hidden; }
        #game-container { position: relative; width: 100%; max-width: 500px; border: 2px solid #0ff; box-shadow: 0 0 20px rgba(0, 255, 255, 0.7); cursor: none; }
        
        /* UPDATED: Default background and new dynamic background styles */
        canvas { 
            display: block; 
            width: 100%; 
            height: auto; 
            background-color: #020418; /* Fallback color */
            transition: background 1s ease-in-out; /* Smooth transition for background changes */
        }
        .bg-1 { background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%); }
        .bg-2 { background: radial-gradient(ellipse at bottom, #4a1a3c 0%, #090a0f 100%); }
        .bg-3 { background: radial-gradient(ellipse at bottom, #1b3a30 0%, #090a0f 100%); }

        .menu { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(10, 20, 40, 0.9); padding: 2rem; border-radius: 15px; text-align: center; border: 1px solid #0ff; backdrop-filter: blur(5px); width: 85%; cursor: default; z-index: 10; }
        .menu h1 { margin-top: 0; font-size: 2rem; color: #0ff; text-shadow: 0 0 10px #0ff; }
        .menu p { margin-bottom: 20px; color: #eee; font-size: 1.1rem; }
        .menu button { background: linear-gradient(45deg, #0ff, #0a8a8a); border: none; color: #fff; padding: 12px 25px; margin: 10px 5px; cursor: pointer; font-size: 1.1rem; font-weight: bold; border-radius: 8px; transition: all 0.3s ease; }
        .menu button:hover { transform: scale(1.05); box-shadow: 0 0 15px #0ff; }
        .menu button:disabled { background: #555; cursor: not-allowed; transform: none; box-shadow: none; }
        
        #ui-container { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; align-items: center; font-size: clamp(16px, 4vw, 18px); font-weight: bold; text-shadow: 0 0 5px #000; z-index: 5; pointer-events: none; }
        #ui-container span { background: rgba(0,0,0,0.4); padding: 5px 10px; border-radius: 8px; }
        #pause-btn { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.4); border: 1px solid #0ff; color: white; font-size: 20px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; z-index: 6; pointer-events: all; display: none; }
        
        #upgrade-shop .upgrade-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; }
        #upgrade-shop .upgrade-item span { text-align: left; flex-basis: 50%; }
    </style>
</head>
<body>
<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="ui-container" style="display: none;">
        <span id="score"></span><span id="stage-info"></span><span id="coins"></span><span id="lives"></span>
    </div>
    <button id="pause-btn">‚öôÔ∏è</button>

    <!-- Menus -->
    <div id="main-menu" class="menu">
        <h1>Space Warfare</h1>
        <button id="start-game-btn">Start Game</button>
        <button id="upgrade-shop-btn">Upgrade Shop</button>
    </div>
    <div id="pause-menu" class="menu" style="display: none;">
        <h1>Paused</h1>
        <button id="resume-btn">Resume</button>
        <button id="sound-toggle-btn">Sound: On</button>
        <button id="restart-from-pause-btn">Restart</button>
    </div>
     <div id="upgrade-shop" class="menu" style="display: none;">
        <h1>Upgrade Shop</h1>
        <p>Your Total Coins: <span id="shop-coins">0</span> ü™ô</p>
        <div class="upgrade-item">
            <span>Extra Life (Lv. <span id="life-level">0</span>)</span>
            <button id="buy-life-btn">Buy (50 ü™ô)</button>
        </div>
        <div class="upgrade-item">
            <span>Weapon Power (Lv. <span id="power-level">0</span>)</span>
            <button id="buy-power-btn">Buy (75 ü™ô)</button>
        </div>
        <div class="upgrade-item">
            <span>Coin Value (Lv. <span id="coin-value-level">0</span>)</span>
            <button id="buy-coin-value-btn">Buy (100 ü™ô)</button>
        </div>
        <button id="back-to-main-menu-btn">Back to Menu</button>
    </div>
    <div id="transition-menu" class="menu" style="display: none;"><h1 id="transition-title"></h1><p id="transition-text"></p></div>
    <div id="game-over-menu" class="menu" style="display: none;">
        <h1>Game Over!</h1>
        <p id="final-stats"></p>
        <button id="restart-button">Play Again</button>
        <button id="revive-btn">Revive (1 ‚ù§Ô∏è)</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 500; canvas.height = 700;

    // --- DOM Elements ---
    const uiContainer = document.getElementById('ui-container');
    const scoreEl = document.getElementById('score');
    const stageInfoEl = document.getElementById('stage-info');
    const livesEl = document.getElementById('lives');
    const coinsEl = document.getElementById('coins');
    const mainMenu = document.getElementById('main-menu');
    const transitionMenu = document.getElementById('transition-menu');
    const transitionTitle = document.getElementById('transition-title');
    const transitionText = document.getElementById('transition-text');
    const gameOverMenu = document.getElementById('game-over-menu');
    const finalStatsEl = document.getElementById('final-stats');
    const pauseBtn = document.getElementById('pause-btn');
    const pauseMenu = document.getElementById('pause-menu');
    const soundToggleBtn = document.getElementById('sound-toggle-btn');
    
    // --- Audio ---
    let isSoundOn = true;
    // UPDATED: Added new sound for player getting hit
    const sounds = {
        fire: new Audio('data:audio/wav;base64,UklGRlIAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABgAZGF0YUYAAAD///////////+AgP//gID//35+f3x7e3R0c3N1dHVzdHRycnJybnFxZmZlZWVlZWVmZmZmZmFhYGBgX19fXl5eXl5dXFxcW1tbW1xcXFtbWlpaWlpaWlpaWlpaWllZWVlZWVlZWFlYWFhYWFdXV1dXV1ZWVlZWVlVUVFRUVFRUVFRUVFNTU1NTU1NTU1NTUlJSUlJSUlJSUlJSUk5OTk5OTk5OTk5OTk1NTU1NTU1NTU1NTS0tLS0tLS0tLS0tLS0pKSkpKSkpKSkpKSEhISEhISEhISEdHR0dHR0dHR0dHR0ZGRkZGRkZGRkZGRkREREQ=='),
        enemyFire: new Audio('data:audio/wav;base64,UklGRiYAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABgAZGF0YRICAAAA//8/f35+fn5+fn5+fn59fX19fX19fX19fHx8fHx8fHx8e3t7e3t7e3t6enp6enp6eXl5eXl5eXh4eHh4eHh3d3d3d3d2dnZ2dnZ2dnZ1dXV1dXV0dHR0dHRzc3Nzc3NycXFx'),
        explosion: new Audio('data:audio/wav;base64,UklGRkgBAABXQVZFZm10IBAAAAABAAEAESsAAFWsAAACABAATElTVBoAAABkYXRhQAEAAMy+w75/sKvAwb13t8e6wbu1y8C+s8S9sMC7vci9vsW/vby/wMC8wsS7vMK8wLu/v8O+wMC/v7/Av7/AwL/AwL+/wL/AwL/Av7+/wL/Av7+/wL+/v8C/v8C/v7/Av7+/wL/Av7/Av7+/wL+/v8C/v7/Av7+/wL+/v8C/v7/Ag=='),
        powerup: new Audio('data:audio/wav;base64,UklGRlQBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABgAZGF0YUwBAAB1dXV4eXh5eXl6enp7e3t7e3t7e3t8fHx8fHx9fX1+fn5/f39/f3+AgICAgICAgICBgYGBgYGBgYKCgoKCgoKCgoODg4ODg4ODg4SEhISEhISEhIWFhYWFhYWFhYaGhoaGhoaGhoaIiIiIiIiIiIiJiYmJiYmJiYmKioqKioqKioqLi4uLi4uLi4uMjIyMjIyMjIyNjY2NjY2NjY2Ojo6Ojo6Ojo6Pj4+Pj4+Pj4+QkJCA=='),
        hit: new Audio('data:audio/wav;base64,UklGRjwAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABgAZGF0YSAAAAAA//8CAP3+/fj39vX08/Lx8O/u7uns6Obe2tXSzcPCvbaqo56BfnNlQyUJAQ==')
    };
    Object.values(sounds).forEach(s => { s.volume = 0.2; });
    const playSound = (sound) => { if (!isSoundOn) return; sound.cloneNode().play().catch(e => {}); };

    // --- Upgrade System ---
    const upgradeShopEl = document.getElementById('upgrade-shop');
    let totalCoins = 0;
    let upgrades = {
        life: { level: 0, cost: 50, maxLevel: 5 },
        power: { level: 0, cost: 75, maxLevel: 5 },
        coinValue: { level: 0, cost: 100, maxLevel: 4 } 
    };

    function loadGameData() {
        const savedCoins = localStorage.getItem('totalCoins');
        const savedUpgrades = localStorage.getItem('upgrades');
        if (savedCoins) totalCoins = parseInt(savedCoins, 10);
        if (savedUpgrades) upgrades = JSON.parse(savedUpgrades);
    }

    function saveGameData() {
        localStorage.setItem('totalCoins', totalCoins);
        localStorage.setItem('upgrades', JSON.stringify(upgrades));
    }

    function updateShopUI() {
        document.getElementById('shop-coins').innerText = totalCoins;
        
        const life = upgrades.life;
        document.getElementById('life-level').innerText = life.level;
        const buyLifeBtn = document.getElementById('buy-life-btn');
        buyLifeBtn.innerText = `Buy (${life.cost} ü™ô)`;
        buyLifeBtn.disabled = totalCoins < life.cost || life.level >= life.maxLevel;
        if(life.level >= life.maxLevel) buyLifeBtn.innerText = 'Max Level';

        const power = upgrades.power;
        document.getElementById('power-level').innerText = power.level;
        const buyPowerBtn = document.getElementById('buy-power-btn');
        buyPowerBtn.innerText = `Buy (${power.cost} ü™ô)`;
        buyPowerBtn.disabled = totalCoins < power.cost || power.level >= power.maxLevel;
        if(power.level >= power.maxLevel) buyPowerBtn.innerText = 'Max Level';

        const coinValue = upgrades.coinValue;
        document.getElementById('coin-value-level').innerText = coinValue.level;
        const buyCoinValueBtn = document.getElementById('buy-coin-value-btn');
        buyCoinValueBtn.innerText = `Buy (${coinValue.cost} ü™ô)`;
        buyCoinValueBtn.disabled = totalCoins < coinValue.cost || coinValue.level >= coinValue.maxLevel;
         if(coinValue.level >= coinValue.maxLevel) buyCoinValueBtn.innerText = 'Max Level';
    }

    function buyUpgrade(type) {
        const upgrade = upgrades[type];
        if (totalCoins >= upgrade.cost && upgrade.level < upgrade.maxLevel) {
            totalCoins -= upgrade.cost;
            upgrade.level++;
            upgrade.cost = Math.floor(upgrade.cost * 1.8);
            saveGameData();
            updateShopUI();
            playSound(sounds.powerup);
        }
    }

    // --- Classes ---
    class GameObject { constructor(x,y,w,h){this.x=x;this.y=y;this.width=w;this.height=h;} }
    class Player extends GameObject {
        constructor(){super(canvas.width/2-25,canvas.height-85,50,55);this.lives=3+upgrades.life.level;this.coins=0;this.score=0;this.companions=0;this.gunType='normal';this.gunLevel=1+upgrades.power.level;this.shootCooldown=0;this.magnetActive=false;this.magnetTimer=0;}
        draw(){for(let i=0;i<this.companions;i++){ctx.fillStyle='#0ff';ctx.beginPath();ctx.arc(this.x-25+(i*(this.width+50))+this.width/2,this.y+this.height/2,8,0,Math.PI*2);ctx.fill();}const f=Math.random()*15+10;ctx.fillStyle=`rgba(255,${Math.random()*150},0,0.8)`;ctx.fillRect(this.x+this.width/2-4,this.y+this.height,8,f);ctx.fillStyle='#ccc';ctx.beginPath();ctx.moveTo(this.x+this.width/2,this.y);ctx.lineTo(this.x,this.y+this.height*0.8);ctx.quadraticCurveTo(this.x+this.width/2,this.y+this.height,this.x+this.width,this.y+this.height*0.8);ctx.closePath();ctx.fill();ctx.fillStyle=this.magnetActive?'#ff0':'#0ff';ctx.beginPath();ctx.arc(this.x+this.width/2,this.y+this.height*0.4,this.width/6,0,Math.PI*2);ctx.fill();}
        update(){if(this.shootCooldown>0)this.shootCooldown--;else this.shoot();if(this.magnetTimer>0)this.magnetTimer--;else this.magnetActive=false;this.draw();}
        shoot(){this.shootCooldown=10;playSound(sounds.fire);for(let i=0;i<this.companions;i++){game.projectiles.push(new Projectile(this.x-25+(i*(this.width+50))+this.width/2,this.y+this.height/2,'normal',1,0));}const s=-9,a=0.2;if(this.gunType==='laser')game.projectiles.push(new Projectile(this.x+this.width/2,this.y,'laser',this.gunLevel,0));else if(this.gunType==='missile')game.projectiles.push(new Projectile(this.x+this.width/2,this.y,'missile',this.gunLevel,0));else if(this.gunType==='spread'){for(let i=0;i<this.gunLevel+1;i++)game.projectiles.push(new Projectile(this.x+this.width/2,this.y,'spread',this.gunLevel,(i-(this.gunLevel)/2)*1.5));}else if(this.gunType==='homing')game.projectiles.push(new Projectile(this.x+this.width/2,this.y,'homing',this.gunLevel,0));else{game.projectiles.push(new Projectile(this.x+this.width/2-(5*this.gunLevel-5),this.y,'normal',this.gunLevel,0));if(this.gunLevel>1)game.projectiles.push(new Projectile(this.x+this.width/2+(5*this.gunLevel-5),this.y,'normal',this.gunLevel,0));if(this.gunLevel>2)game.projectiles.push(new Projectile(this.x+this.width/2,this.y,'normal',this.gunLevel,a*s));if(this.gunLevel>3)game.projectiles.push(new Projectile(this.x+this.width/2,this.y,'normal',this.gunLevel,-a*s));}}
        takeDamage(){this.lives--;if(this.lives<0)this.lives=0;this.gunLevel=Math.max(1, 1+upgrades.power.level);this.gunType='normal';this.companions=0;}
    }
    class Projectile extends GameObject {
        constructor(x,y,type,level,velX){const c={'normal':{w:5,h:10,c:'#0ff',s:-9},'laser':{w:4,h:20,c:'#ff0',s:-14},'missile':{w:8,h:15,c:'#f90',s:-6},'spread':{w:5,h:10,c:'#0f0',s:-9},'homing':{w:8,h:8,c:'#f0f',s:-9},'enemy':{w:7,h:7,c:'#FF4081',s:4}};const a=c[type]||c.enemy;super(x-a.w/2,y,a.w,a.h);this.type=type;this.velocity={x:velX||0,y:a.s};this.color=a.c;}
        update(){if(this.type==='homing'&&(game.enemies.length+game.bosses.length>0)){let cl=null,md=Infinity;game.enemies.concat(game.bosses).forEach(e=>{const d=Math.hypot(this.x-e.x,this.y-e.y);if(d<md){md=d;cl=e;}});if(cl){const an=Math.atan2(cl.y-this.y,cl.x-this.x);this.velocity.x=Math.cos(an)*9;this.velocity.y=Math.sin(an)*9;}}this.x+=this.velocity.x;this.y+=this.velocity.y;
            ctx.fillStyle=this.color;
            ctx.shadowColor=this.color;
            ctx.shadowBlur = 15;
            if (this.type === 'enemy') {
                ctx.beginPath();
                ctx.arc(this.x + this.width / 2, this.y + this.height / 2, this.width / 2, 0, Math.PI * 2);
                ctx.fill();
            } else {
                ctx.fillRect(this.x,this.y,this.width,this.height);
            }
            ctx.shadowBlur=0;
        }
    }
    class Enemy extends GameObject {
        constructor(c){super(c.x,c.y,c.size,c.size);this.type=c.type;this.hp=c.hp;this.maxHp=c.hp;this.velocity=c.velocity;this.shootCooldown=Math.random()*100+(150 / game.stage);}
        draw() {
            const colors = {'fast': '#ff5555', 'tank': '#55aaff', 'standard': '#99ff99'};
            ctx.fillStyle = colors[this.type] || '#99ff99';
            ctx.beginPath();
            ctx.moveTo(this.x + this.width / 2, this.y);
            ctx.lineTo(this.x + this.width, this.y + this.height * 0.8);
            ctx.lineTo(this.x + this.width * 0.7, this.y + this.height);
            ctx.lineTo(this.x + this.width * 0.3, this.y + this.height);
            ctx.lineTo(this.x, this.y + this.height * 0.8);
            ctx.closePath();
            ctx.fill();
            if(this.hp < this.maxHp){ctx.fillStyle='red';ctx.fillRect(this.x,this.y-7,this.width,4);ctx.fillStyle='lime';ctx.fillRect(this.x,this.y-7,this.width*(this.hp/this.maxHp),4);}
        }
        update(){this.x+=this.velocity.x;this.y+=this.velocity.y;if(this.shootCooldown--<=0){this.shoot();}if(this.x<=0||this.x+this.width>=canvas.width)this.velocity.x*=-1;this.draw();}
        shoot(){if (game.state !== 'playing') return; this.shootCooldown=Math.random()*100+(150 / game.stage); game.enemyProjectiles.push(new Projectile(this.x+this.width/2,this.y+this.height,'enemy',1,0)); playSound(sounds.enemyFire);}
        takeDamage(){this.hp--;return this.hp<=0;}
    }
    class Boss extends Enemy {
        constructor(c){super(c);this.patterns=c.patterns;this.patternIndex=0;this.patternTimer=this.patterns[0].duration;}
        draw(){
            ctx.fillStyle = '#4a4a6a';
            ctx.beginPath();
            ctx.moveTo(this.x + this.width * 0.5, this.y); 
            ctx.lineTo(this.x + this.width, this.y + this.height * 0.4); 
            ctx.lineTo(this.x + this.width * 0.8, this.y + this.height); 
            ctx.lineTo(this.x + this.width * 0.2, this.y + this.height); 
            ctx.lineTo(this.x, this.y + this.height * 0.4); 
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#00ffff';
            ctx.beginPath();
            ctx.arc(this.x + this.width / 2, this.y + this.height * 0.3, this.width * 0.1, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle='red';ctx.fillRect(50,20,canvas.width-100,20);ctx.fillStyle='lime';ctx.fillRect(50,20,(canvas.width-100)*(this.hp/this.maxHp),20);
        }
        update(){if(this.patternTimer>0)this.patternTimer--;else{this.patternIndex=(this.patternIndex+1)%this.patterns.length;this.patternTimer=this.patterns[this.patternIndex].duration;}let p=this.patterns[this.patternIndex];this.x+=p.vx;this.y+=p.vy;if(this.x<=0||this.x+this.width>=canvas.width)p.vx*=-1;if(this.y > 150) p.vy = 0; if(this.shootCooldown--<=0)this.shoot();this.draw();}
        shoot(){if (game.state !== 'playing') return; const p=this.patterns[this.patternIndex];this.shootCooldown=p.fireRate; playSound(sounds.enemyFire); if(p.attack.type==='spread'){const angleStep=Math.PI*2/p.attack.count;for(let i=0;i<p.attack.count;i++)game.enemyProjectiles.push(new Projectile(this.x+this.width/2,this.y+this.height/2,'enemy',1,Math.cos(i*angleStep)*3,Math.sin(i*angleStep)*3));}else{game.enemyProjectiles.push(new Projectile(this.x+this.width*0.2,this.y+this.height,'enemy',1,0));game.enemyProjectiles.push(new Projectile(this.x+this.width*0.8,this.y+this.height,'enemy',1,0));}}
    }
    class Loot extends GameObject {
        constructor(x,y,type){super(x,y,25,25);this.type=type;this.speed=2;}
        draw(){let e='‚ùî';if(this.type==='coin')e='ü™ô';else if(this.type==='power_cell')e='üåü';else if(this.type==='magnet')e='üß≤';else if(this.type==='drone')e='ü§ñ';else if(this.type.startsWith('gun_'))e={'gun_laser':'üî•','gun_missile':'üí£','gun_spread':'‚ö°','gun_homing':'üöÄ'}[this.type];ctx.font=`${this.width}px Arial`;ctx.fillText(e,this.x,this.y);}
        update(){if(game.player && game.player.magnetActive){const a=Math.atan2(game.player.y-this.y,game.player.x+game.player.width/2-this.x);this.x+=Math.cos(a)*6;this.y+=Math.sin(a)*6;}else{this.y+=this.speed;}this.draw();}
    }
    class Star extends GameObject {
        constructor(){super(Math.random()*canvas.width,Math.random()*canvas.height,Math.random()*2,0);this.velocity=Math.random()*0.5+0.2;}
        draw(){ctx.fillStyle='white';ctx.beginPath();ctx.arc(this.x,this.y,this.width,0,Math.PI*2);ctx.fill();}
        update(){this.y+=this.velocity;if(this.y>canvas.height){this.y=-this.width;this.x=Math.random()*canvas.width;}this.draw();}
    }
    
    // --- Game State & Logic ---
    let game = { state: 'menu', stars: [] };
    for(let i=0;i<100;i++)game.stars.push(new Star());
    
    function init() {
        game = {
            ...game,
            player: new Player(), projectiles: [], enemies: [], bosses: [], lootItems: [], enemyProjectiles: [],
            stage: 1,
            enemiesToSpawnThisStage: 0,
            spawnTimer: 0,
            hasRevived: false
        };
        setupStage();
    }
    
    function setupStage() {
        const stage = game.stage;

        // UPDATED: Dynamic background logic
        const numBackgrounds = 3;
        const bgIndex = ((stage - 1) % numBackgrounds) + 1;
        canvas.classList.remove('bg-1', 'bg-2', 'bg-3');
        canvas.classList.add(`bg-${bgIndex}`);

        if (stage % 4 === 0) { // BOSS STAGE
            game.enemiesToSpawnThisStage = 0;
            const bossHp = 100 + (stage * 25);
            const bossSize = 100 + (stage * 5);
            game.bosses.push(new Boss({x:canvas.width/2 - bossSize/2, y:-bossSize, size:bossSize, hp:bossHp, patterns:[
                {duration:200,vx:1,vy:0.5,fireRate:20,attack:{type:'barrage'}},
                {duration:150,vx:0,vy:0,fireRate:40,attack:{type:'spread',count:8 + Math.floor(stage/4)}}
            ]}));
        } else { // REGULAR STAGE
            game.enemiesToSpawnThisStage = 15 + stage * 7; 
            game.spawnTimer = 100;
        }
        updateUI();
    }

    function spawnEnemy() {
        if (game.enemiesToSpawnThisStage <= 0) return;
        
        game.spawnTimer --;
        if (game.spawnTimer <= 0) {
            game.enemiesToSpawnThisStage--;
            game.spawnTimer = Math.max(20, 100 - game.stage * 5);

            const stage = game.stage;
            let t='standard', h=stage, v={x:Math.random() * 2 - 1,y:1};
            if(Math.random()<0.3 + stage * 0.02){ t='fast'; v.y=1.5; h=Math.ceil(stage/2); }
            else if(Math.random()<0.15 + stage * 0.01){ t='tank'; h=stage*2; }
            
            game.enemies.push(new Enemy({x:Math.random()*(canvas.width-40)+20,y:-50,size:35,type:t,hp:h,velocity:v}));
        }
    }

    function spawnLoot(x,y){const r=Math.random();let t='coin';if(r<0.02)t='drone';else if(r<0.04)t='gun_homing';else if(r<0.06)t='gun_missile';else if(r<0.08)t='gun_laser';else if(r<0.10)t='gun_spread';else if(r<0.20)t='power_cell';else if(r<0.25)t='magnet';else if(r>0.50)t='coin';game.lootItems.push(new Loot(x,y,t));}
    
    function updateUI(){if(!game.player) return; scoreEl.innerText=`Score:${game.player.score}`;stageInfoEl.innerText=`Stage: ${game.stage}`;coinsEl.innerText=`ü™ô ${game.player.coins}`;livesEl.innerHTML=`Lives:${'‚ù§Ô∏è'.repeat(game.player.lives)}`;}
    
    function handleCollisions(){
        if (!game.player) return;
        for(let i=game.projectiles.length-1;i>=0;i--){const p=game.projectiles[i];for(let j=game.enemies.length-1;j>=0;j--){const e=game.enemies[j];if(isColliding(p,e)){game.projectiles.splice(i,1);if(e.takeDamage()){playSound(sounds.explosion);spawnLoot(e.x,e.y);game.player.score+=100*game.stage;game.enemies.splice(j,1);updateUI();}break;}}}
        for(let i=game.projectiles.length-1;i>=0;i--){const p=game.projectiles[i];for(let j=game.bosses.length-1;j>=0;j--){const b=game.bosses[j];if(isColliding(p,b)){game.projectiles.splice(i,1);if(b.takeDamage()){playSound(sounds.explosion);for(let k=0; k<10; k++) spawnLoot(b.x + Math.random()*b.width, b.y + Math.random()*b.height);game.player.score+=1000*game.stage;game.bosses.splice(j,1);updateUI();}break;}}}
        // UPDATED: Player now plays 'hit' sound on damage, not explosion.
        for(let i=game.enemyProjectiles.length-1;i>=0;i--)if(isColliding(game.enemyProjectiles[i],game.player)){game.enemyProjectiles.splice(i,1);game.player.takeDamage();playSound(sounds.hit);updateUI();if(game.player.lives<=0)changeState('gameOver');}
        for(let i=game.enemies.length-1;i>=0;i--)if(isColliding(game.enemies[i],game.player)){game.enemies.splice(i,1);game.player.takeDamage();playSound(sounds.hit);updateUI();if(game.player.lives<=0)changeState('gameOver');}
        for(let i=game.lootItems.length-1;i>=0;i--){const l=game.lootItems[i];if(isColliding(l,game.player)){playSound(sounds.powerup);
            if(l.type==='coin') game.player.coins += (1 + upgrades.coinValue.level);
            else if(l.type==='power_cell')game.player.gunLevel=Math.min(5,game.player.gunLevel+1);
            else if(l.type==='drone'&&game.player.companions<2)game.player.companions++;
            else if(l.type==='magnet'){game.player.magnetActive=true;game.player.magnetTimer=300;}
            else if(l.type.startsWith('gun_'))game.player.gunType=l.type.replace('gun_','');
            game.lootItems.splice(i,1);updateUI();
        }}
    }
    
    let animationFrameId;
    function gameLoop() {
        animationFrameId = requestAnimationFrame(gameLoop);
        // UPDATED: Clearing is now handled by the background styles, but clearRect is still a good failsafe
        ctx.clearRect(0,0,canvas.width,canvas.height);
        game.stars.forEach(s=>s.update());
        
        if (game.state === 'playing') {
            game.player.update();
            spawnEnemy();
            [game.projectiles,game.enemies,game.bosses,game.lootItems,game.enemyProjectiles].forEach(arr => arr.forEach(item=>item.update()));
            handleCollisions();
            
            game.projectiles=game.projectiles.filter(p=>p.y>0);
            game.enemyProjectiles=game.enemyProjectiles.filter(p=>p.y<canvas.height);
            game.lootItems=game.lootItems.filter(l=>l.y<canvas.height);
            game.enemies=game.enemies.filter(e=>e.y < canvas.height);
            
            if (game.enemiesToSpawnThisStage === 0 && game.enemies.length === 0 && game.bosses.length === 0) {
                changeState('stageClear');
            }
        }
    }
    
    // Developer:- @Black_Hats_Hackers
    
    function changeState(newState) {
        if (game.state === 'transitioning' && newState !== 'playing') return;
        if (game.state === newState) return;
        
        game.state = newState;

        const allMenus = [mainMenu, transitionMenu, gameOverMenu, pauseMenu, upgradeShopEl];
        allMenus.forEach(menu => menu.style.display = 'none');
        uiContainer.style.display = 'none';
        pauseBtn.style.display = 'none';

        if (newState === 'playing') {
            uiContainer.style.display = 'flex';
            pauseBtn.style.display = 'block';
        } else if (newState === 'gameOver') {
            totalCoins += game.player.coins;
            saveGameData();
            gameOverMenu.style.display = 'block';
            finalStatsEl.innerText = `Final Score: ${game.player.score} | Coins Collected: ü™ô${game.player.coins}`;
            
            const reviveBtn = document.getElementById('revive-btn');
            if (game.hasRevived) {
                reviveBtn.style.display = 'none';
            } else {
                reviveBtn.style.display = 'inline-block';
            }

        } else if (newState === 'stageClear') {
            game.state = 'transitioning';
            let title = `Stage ${game.stage} Complete!`;
            let text = (game.stage + 1) % 4 === 0 ? 'A Boss is approaching...' : 'Get ready for the next stage...';
            
            transitionTitle.innerText = title;
            transitionText.innerText = text;
            transitionMenu.style.display = 'block';
            
            setTimeout(() => {
                game.stage++;
                setupStage();
                changeState('playing');
            }, 2500);
        } else if (newState === 'paused') {
            pauseMenu.style.display = 'block';
        } else if (newState === 'menu') {
            mainMenu.style.display = 'block';
        } else if (newState === 'shop') {
            updateShopUI();
            upgradeShopEl.style.display = 'block';
        }
    }
    
    function isColliding(r1,r2){return r1.x<r2.x+r2.width&&r1.x+r1.width>r2.x&&r1.y<r2.y+r2.height&&r1.y+r1.height>r2.y;}
    
    // --- Event Listeners ---
    function handlePlayerMove(e){if(!game.player||game.state!=='playing')return;e.preventDefault();const r=canvas.getBoundingClientRect();const cX=e.touches?e.touches[0].clientX:e.clientX;game.player.x=Math.max(0,Math.min(canvas.width-game.player.width,((cX-r.left)/r.width*canvas.width)-game.player.width/2));}
    canvas.addEventListener('mousemove',handlePlayerMove);canvas.addEventListener('touchmove',handlePlayerMove,{passive:false});canvas.addEventListener('touchstart',handlePlayerMove,{passive:false});
    
    document.getElementById('start-game-btn').addEventListener('click',()=>{
        init(); 
        changeState('playing');
    });
    document.getElementById('restart-button').addEventListener('click',()=>{changeState('menu');});
    
    pauseBtn.addEventListener('click', () => { if(game.state === 'playing') changeState('paused'); });
    document.getElementById('resume-btn').addEventListener('click', () => { if(game.state === 'paused') changeState('playing'); });
    document.getElementById('restart-from-pause-btn').addEventListener('click', () => { changeState('menu'); });
    soundToggleBtn.addEventListener('click', () => {
        isSoundOn = !isSoundOn;
        soundToggleBtn.innerText = isSoundOn ? 'Sound: On' : 'Sound: Off';
    });
    
    document.getElementById('upgrade-shop-btn').addEventListener('click', () => changeState('shop'));
    document.getElementById('back-to-main-menu-btn').addEventListener('click', () => changeState('menu'));
    document.getElementById('buy-life-btn').addEventListener('click', () => buyUpgrade('life'));
    document.getElementById('buy-power-btn').addEventListener('click', () => buyUpgrade('power'));
    document.getElementById('buy-coin-value-btn').addEventListener('click', () => buyUpgrade('coinValue'));

    document.getElementById('revive-btn').addEventListener('click', () => {
        if (game.state === 'gameOver' && !game.hasRevived) {
            game.hasRevived = true;
            game.player.lives = 1;
            game.enemyProjectiles = [];
            playSound(sounds.powerup);
            updateUI();
            changeState('playing');
        }
    });

    // --- Initial Load ---
    loadGameData();
    changeState('menu');
    gameLoop();
</script>
</body>
    </html>
